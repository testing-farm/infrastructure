---

#
# Add tag repository with low priority, for installing additional dependencies of tested artifacts.
#
# The tag repository is updated by Brew/Koji. It contains all packages that got into a specific tag.
# The repository is sometimes also referred to as buildroot or brewroot repository inside Red Hat.
#
# Examples for RHEL:
# * rhel-8.1.0-build contains all builds tagged into rhel-8.1.0-candidate
# * rhel-8.1.0-z-build contains all builds tagged into rhel-8.1.0-z-candidate
# * rhel-7.7-build contains all builds tagged into rhel-7.7-candidate
# * rhel-9.0.0-beta-build contains all builds tagged into rhel-9.0.0-beta-candidate
#
# Note that *-build tags inherit from *-candidate tags
#
# Testing Farm needs to deduce the tag repository according to the tested image name.
# We're adding both Z-Stream and non Z-Stream tag repositories with skip_if_unavailable=True option.
#

- block:
    - name: Transform build target to a tag repository name (RHEL 7 and older, RHEL 10 and newer)
      set_fact:
        tag_repository_name_mainline: "rhel-{{ ansible_distribution_version }}-build"
        tag_repository_name_z_stream: "rhel-{{ ansible_distribution_version }}-z-build"
      when:
        - ansible_distribution == "RedHat"
        - ansible_distribution_major_version|int <= 7 or ansible_distribution_major_version|int >= 10

    - name: Transform build target to a tag repository name (RHEL 8, RHEL 9)
      set_fact:
        tag_repository_name_mainline: "rhel-{{ ansible_distribution_version }}.0-build"
        tag_repository_name_z_stream: "rhel-{{ ansible_distribution_version }}.0-z-build"
      when:
        - ansible_distribution == "RedHat"
        - ansible_distribution_major_version|int == 8 or ansible_distribution_major_version|int == 9

    - name: Create tag repository base url (RHEL)
      set_fact:
        tag_repository_url_mainline: "http://download.devel.redhat.com/brewroot/repos/{{ tag_repository_name_mainline }}/latest/{{ ansible_architecture }}/"
        tag_repository_url_z_stream: "http://download.devel.redhat.com/brewroot/repos/{{ tag_repository_name_z_stream }}/latest/{{ ansible_architecture }}/"

    #
    # Set the priority to lowest, this will make sure latest updates are not pulled in instead of default repository
    #
    - name: Set tag repository priority
      set_fact:
        tag_repository_priority: 999

    #
    # Handle RHEL7
    #
    - block:
        # On RHUI systems enable optional repositories
        - name: Enable optional repo on RHUI systems
          command: yum-config-manager --enable rhel-7-server-rhui-optional-rpms
          when: "'rhui' in IMAGE_NAME|lower"

        # Install yum-plugin-priorities to support repository priorities
        - name: Make sure yum-plugin-priorities is installed on < RHEL8
          package:
            name: yum-plugin-priorities
            state: present
          retries: "{{ pkg_retry_count }}"
          delay: "{{ pkg_retry_delay }}"
          until: result_package is succeeded
          register: result_package

      when:
        - ansible_distribution == "RedHat"
        - ansible_distribution_major_version|int < 8

    #
    # block: end
    #

    - name: Add tag repository
      template:
        src: "../templates/tag.repo.j2"
        dest: "/etc/yum.repos.d/tag-repository-{{ tag_repository_type }}.repo"
      loop:
        - { type: "mainline", url: "{{ tag_repository_url_mainline }}" }
        - { type: "z-stream", url: "{{ tag_repository_url_z_stream }}" }
      vars:
        tag_repository_url: "{{ item.url }}"
        tag_repository_type: "{{ item.type }}"

  when:
    - IMAGE_NAME is defined
    - ansible_distribution == "RedHat"
    - '"auto-osbuild" not in IMAGE_NAME|lower'
    - '"composer-api" not in IMAGE_NAME|lower'
    - '"hardened" not in IMAGE_NAME|lower'

  #
  # block: end
  #

#
# Be verbose about the fact we skipped this play
#
- debug:
    msg: |
      Skipping adding tag repository, because IMAGE_NAME variable is undefined,
      or it is unsupported.

  when: >
    IMAGE_NAME is undefined
    or '"auto-osbuild" in IMAGE_NAME|lower'
    or '"composer-api" in IMAGE_NAME|lower'
    or '"hardened" in IMAGE_NAME|lower'
