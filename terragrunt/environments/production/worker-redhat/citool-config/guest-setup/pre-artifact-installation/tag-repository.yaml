---

#
# Add tag repository with low priority, for installing additional dependencies of tested artifacts.
#
# The tag repository is updated by Brew/Koji. It contains all packages that got into a specific tag.
# The repository is sometimes also referred to as buildroot or brewroot repository inside Red Hat.
#
# Examples for RHEL:
# * rhel-8.1.0-build contains all builds tagged into rhel-8.1.0-candidate
# * rhel-8.1.0-z-build contains all builds tagged into rhel-8.1.0-z-candidate
# * rhel-7.7-build contains all builds tagged into rhel-7.7-candidate
# * rhel-9.0.0-beta-build contains all builds tagged into rhel-9.0.0-beta-candidate
#
# Note that *-build tags inherit from *-candidate tags
#
# The play gracefully skips adding a tag repository which is not reachable.
#
# Testing Farm needs to deduce the tag repository according to the tested image name.
# For now we try first adding the Z-Stream tag repository and fallback to non Z-Stream.
#
# Issues:
# * TFT-1256 (Z-stream support)
#

- block:

    #
    # The tag repository name can be transformed from IMAGE_NAME variable.
    #
    - name: Transform build target to a tag repository name (RHEL-X.Y or RHEL-X.Y.Z)
      set_fact:
        tag_repository_name_mainline: "{{ IMAGE_NAME | regex_replace('(?i)^.*rhel-(\\d+\\.\\d+(?:\\.\\d+)?(?:-alpha|-beta)?).*$', 'rhel-\\1-build') | lower }}"
        tag_repository_name_z_stream: "{{ IMAGE_NAME | regex_replace('(?i)^.*rhel-(\\d+\\.\\d+(?:\\.\\d+)?(?:-alpha|-beta)?).*$', 'rhel-\\1-z-build') | lower }}"

    # TFT-2798: find a better solution then hardcoding the mappings here
    # Note that on purpose we do not add mappings for RHEL-8-Updated and RHEL-8-Released,
    # would be weird to include there the latest built packages wouldn't it?
    - name: Transform build target to a tag repository name (RHEL-8-Nightly)
      set_fact:
        tag_repository_name_mainline: "rhel-8.10.0-build"
        tag_repository_name_z_stream: "rhel-8.10.0-z-build"
      when: IMAGE_NAME == "RHEL-8-Nightly" or IMAGE_NAME == "RHEL-8-Devel"

    - name: Transform build target to a tag repository name (RHEL-9-Nightly)
      set_fact:
        tag_repository_name_mainline: "rhel-9.7.0-build"
        tag_repository_name_z_stream: "rhel-9.7.0-z-build"
      when: IMAGE_NAME == "RHEL-9-Nightly"

    - name: Transform build target to a tag repository name (RHEL-10-Nightly)
      set_fact:
        tag_repository_name_mainline: "rhel-10.1-build"
        tag_repository_name_z_stream: "rhel-10.1-z-build"
      when: IMAGE_NAME == "RHEL-10-Nightly"

    - name: Create tag repository base url (RHEL)
      set_fact:
        tag_repository_url_mainline: "http://download.devel.redhat.com/brewroot/repos/{{ tag_repository_name_mainline }}/latest/{{ ansible_architecture }}/"
        tag_repository_url_z_stream: "http://download.devel.redhat.com/brewroot/repos/{{ tag_repository_name_z_stream }}/latest/{{ ansible_architecture }}/"

    #
    # Set the priority to lowest, this will make sure latest updates are not pulled in instead of default repository
    #
    - name: Set tag repository priority
      set_fact:
        tag_repository_priority: 999

    #
    # Handle RHEL7
    #
    - block:
        # On RHUI systems enable optional repositories
        - name: Enable optional repo on RHUI systems
          command: yum-config-manager --enable rhel-7-server-rhui-optional-rpms
          when: "'rhui' in IMAGE_NAME|lower"

        # Install yum-plugin-priorities to support repository priorities
        - name: Make sure yum-plugin-priorities is installed on < RHEL8
          package:
            name: yum-plugin-priorities
            state: present
          retries: "{{ pkg_retry_count }}"
          delay: "{{ pkg_retry_delay }}"
          until: result_package is succeeded
          register: result_package

      when:
        - ansible_distribution == "RedHat"
        - ansible_distribution_major_version|int < 8

    - name: Add tag repository
      template:
        src: "../templates/tag.repo.j2"
        dest: "/etc/yum.repos.d/tag-repository-{{ tag_repository_type }}.repo"
      loop:
        - { type: "mainline", url: "{{ tag_repository_url_mainline }}" }
        - { type: "z-stream", url: "{{ tag_repository_url_z_stream }}" }
      vars:
        tag_repository_url: "{{ item.url }}"
        tag_repository_type: "{{ item.type }}"

    #
    # block: end
    #

    #
    # Be verbose about the fact the repository is unreachable
    #
    - debug:
        msg: "Skipping adding tag repository, because no available tag repository was found"
      when: tag_repository_url is not defined

  #
  # Run block if BUILD_TARGET and PRIMARY_TASK variables are available.
  # Also, we do not support tag repository for all known task namespaces.
  #

  when:
    - IMAGE_NAME is defined
    - ansible_distribution == "RedHat"
    - '"auto-osbuild" not in IMAGE_NAME|lower'
    - '"composer-api" not in IMAGE_NAME|lower'
    - '"hardened" not in IMAGE_NAME|lower'

  #
  # block: end
  #

#
# Be verbose about the fact we skipped this play
#
- debug:
    msg: |
      Skipping adding tag repository, because IMAGE_NAME variable is undefined,
      or it is unsupported.

  when: >
    IMAGE_NAME is undefined
    or '"auto-osbuild" in IMAGE_NAME|lower'
    or '"composer-api" in IMAGE_NAME|lower'
    or '"hardened" in IMAGE_NAME|lower'
