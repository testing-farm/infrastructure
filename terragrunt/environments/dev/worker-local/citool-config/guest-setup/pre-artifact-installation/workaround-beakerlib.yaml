---
# https://issues.redhat.com/browse/TFT-838
- block:
  - name: Make sure dnf core plugins are installed
    command: "dnf -y install dnf-plugins-core"
    retries: "{{ pkg_retry_count }}"
    delay: "{{ pkg_retry_delay }}"
    until: result_package is succeeded
    register: result_package

  - name: Add beakerlib copr repository for CentOS Stream
    command: "dnf -y copr enable packit/beakerlib-beakerlib-master"
    when:
      - "ansible_distribution_major_version | int < 10"

  # workaround TFT-1284
  - name: Install beakerlib
    command: "dnf -y install beakerlib"
    retries: "{{ pkg_retry_count }}"
    delay: "{{ pkg_retry_delay }}"
    until: result_package is succeeded
    register: result_package

  when:
    - 'ansible_distribution == "CentOS"'
    - 'ansible_distribution_release == "Stream"'
    - '"image-mode" not in IMAGE_NAME|lower'

- block:
  - name: Add beakerlib copr repository for CentOS Stream
    command: "curl -Lo /etc/yum.repos.d/beakerlib-beakerlib-master.repo https://copr.fedorainfracloud.org/coprs/packit/beakerlib-beakerlib-master/repo/epel-{{ ansible_distribution_major_version }}"
    when:
      - "ansible_distribution_major_version | int < 10"

  # workaround TFT-1284
  - name: Install beakerlib
    shell: "rpm -q beakerlib || rpm-ostree install -y -A beakerlib"
    retries: "{{ pkg_retry_count }}"
    delay: "{{ pkg_retry_delay }}"
    until: result_package is succeeded
    register: result_package
    when: "ansible_distribution_major_version | int < 10"

  when:
    - 'ansible_distribution == "CentOS"'
    - 'ansible_distribution_release == "Stream"'
    - '"image-mode" in IMAGE_NAME|lower'
