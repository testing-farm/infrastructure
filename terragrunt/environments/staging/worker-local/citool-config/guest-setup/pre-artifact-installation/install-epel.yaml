- name: Install EPEL on CentOS < 9 and CentOS Stream < 9 (except CentOS Stream 9)
  package:
    name:
      - epel-release
    state: present
  when:
    - 'ansible_distribution == "CentOS"'
    - 'ansible_distribution_major_version | int < 9'
    - '"auto-osbuild" not in IMAGE_NAME|lower'
    - '"image-mode" not in IMAGE_NAME|lower'
  retries: "{{ pkg_retry_count }}"
  delay: "{{ pkg_retry_delay }}"
  until: result_package is succeeded
  register: result_package

- name: Install EPEL on CentOS Stream 9
  package:
    name:
      - epel-release
      - epel-next-release
    state: present
  when:
    - 'ansible_distribution == "CentOS"'
    - 'ansible_distribution_release == "Stream"'
    - 'ansible_distribution_major_version | int == 9'
    - '"image-mode" not in IMAGE_NAME|lower'
  retries: "{{ pkg_retry_count }}"
  delay: "{{ pkg_retry_delay }}"
  until: result_package is succeeded
  register: result_package

- name: Install EPEL on CentOS Stream 9 image-mode
  shell: "rpm -q epel-release || rpm-ostree install -y -A epel-release"
  when:
    - 'ansible_distribution == "CentOS"'
    - 'ansible_distribution_release == "Stream"'
    - 'ansible_distribution_major_version | int == 9'
    - '"image-mode" in IMAGE_NAME|lower'
  retries: "{{ pkg_retry_count }}"
  delay: "{{ pkg_retry_delay }}"
  until: result_package is succeeded
  register: result_package

- name: Install EPEL Next on CentOS Stream 9 image-mode
  shell: "rpm -q epel-next-release || rpm-ostree install -y -A epel-next-release"
  when:
    - 'ansible_distribution == "CentOS"'
    - 'ansible_distribution_release == "Stream"'
    - 'ansible_distribution_major_version | int == 9'
    - '"image-mode" in IMAGE_NAME|lower'
  retries: "{{ pkg_retry_count }}"
  delay: "{{ pkg_retry_delay }}"
  until: result_package is succeeded
  register: result_package

- name: Install EPEL on CentOS Stream 10
  package:
    name:
      - epel-release
    state: present
  when:
    - 'ansible_distribution == "CentOS"'
    - 'ansible_distribution_release == "Stream"'
    - 'ansible_distribution_major_version | int == 10'
    - '"image-mode" not in IMAGE_NAME|lower'
  retries: "{{ pkg_retry_count }}"
  delay: "{{ pkg_retry_delay }}"
  until: result_package is succeeded
  register: result_package
