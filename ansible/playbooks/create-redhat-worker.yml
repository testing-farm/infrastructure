---
- hosts: localhost
  vars_files:
    - ../secrets/credentials.yml
  tasks:
    - name: Provision new EC2 instance
      amazon.aws.ec2_instance:
        profile: redhat_us_east_1
        state: running
        tags:
          Name: "testing_farm_worker_{{ lookup('pipe', 'uuidgen | sed s/-.*//') }}"
          AppCode: ARR-001
          ServiceOwner: TFT
          ServicePhase: Prod
          ServiceName: TestingFarm
          ServiceComponent: Worker
        key_name:  tft-artemis-master-key
        instance_type: i3.2xlarge
        # 1MT-Fedora-35
        image_id: ami-05d30c1f88eee9588
        wait: true
        count: 1
        network:
          assign_public_ip: false
        instance_initiated_shutdown_behavior: terminate
        security_group: sg-0a27e72b0135ea078
        vpc_subnet_id: subnet-0b853a752f0f7eba5
      register: ec2

    - name: Add new instance to host group
      add_host:
        hostname: "{{ item.private_ip_address }}"
        groupname: testing_farm_redhat_workers
      loop: "{{ ec2.instances }}"

    - name: Add new instance to host group
      add_host:
        hostname: "{{ item.private_ip_address }}"
        groupname: new_workers
      loop: "{{ ec2.instances }}"

#
# Wait for ssh connection
#
- hosts: new_workers
  gather_facts: false
  remote_user: fedora
  tasks:
    - name: Wait for SSH to come up
      wait_for_connection:
        delay: 10
        timeout: 600

#
# Setup storage
#
- hosts: new_workers
  gather_facts: false
  remote_user: fedora
  become: true
  vars:
    volume_attached_device: /dev/nvme0n1
    volume_attached_device_mount_path: /data
    volume_attached_device_owner: root
    volume_attached_device_group: root
  roles:
    - volume

#
# Setup worker
#
- hosts: new_workers
  remote_user: fedora
  vars_files:
    - ../secrets/credentials.yml
    - ../vars/common.yml
  pre_tasks:
    - include: ../tasks/dns.yml
    - include: ../tasks/ssh-key.yml
    - include: ../tasks/podman.yml
    - include: ../tasks/jobs.yml
    - include: ../tasks/config.yml
    - include: ../tasks/xunit-viewer.yml
    - include: ../tasks/image.yml
    - include: ../tasks/rh-certs.yml
  roles:
    - name: geerlingguy.swap
      vars:
        swap_file_path: /data/swapfile
        swap_file_size_mb: "16384"
        swap_file_state: present
      become: true
    - name: nomad
  tasks:
    - include: ../tasks/jobs-register.yml
      when: skip_nomad_start is not defined

- hosts: localhost
  tasks:
    - name: Refresh the inventory
      meta: refresh_inventory
