#
# poetry layout
#
layout_poetry() {
  if [[ ! -f pyproject.toml ]]; then
    log_error 'No pyproject.toml found. Use `poetry new` or `poetry init` to create one first.'
    exit 2
  fi

  # create venv if it doesn't exist
  poetry run true

  export VIRTUAL_ENV=$(poetry env info --path)
  export POETRY_ACTIVE=1
  PATH_add "$VIRTUAL_ENV/bin"
}

#
# vars
#
export PROJECT_ROOT=$(pwd)
export DIRENV_PATH="$PROJECT_ROOT/.direnv"
export TOOLS_PATH="$DIRENV_PATH/bin"

#
# poetry
#
if [ -n "$VIRTUAL_ENV" ]; then
    # deactivate any old VIRTUALENV before entering direnv
    # because deactivate is a function created
    # by activate script, run it again to have it available
    . $VIRTUAL_ENV/bin/activate
    deactivate
    # deactivate messes with PS1, unset it to mitigate weird error
    # https://github.com/direnv/direnv/wiki/PS1
    unset PS1
fi
layout_poetry

#
# required
#
if [ ! -e "$PROJECT_ROOT/.vault_pass" ]; then
    echo -e "\e[31mâ›” Please create '.vault_pass' in project root '$PROJECT_ROOT'"
    exit 1
fi

#
# setup
#
if [ ! -e "$DIRENV_PATH" ]; then
  source setup/environment.sh
else
  echo -e "\e[32mðŸ’¡ Use 'make clean; direnv allow' to reinstall\e[0m"
fi

#
# tools
#
PATH_add "$TOOLS_PATH"

#
# download and setup kubectl
#
export AWS_ACCESS_KEY_ID="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yaml | yq -r .credentials.aws.fedora.access_key)"
export AWS_SECRET_ACCESS_KEY="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yaml | yq -r .credentials.aws.fedora.secret_key)"
export AWS_DEFAULT_REGION="us-east-1"

#
# kubectl
#
export KUBECONFIG="$DIRENV_PATH/.kube/config"
export KREW_ROOT="$DIRENV_PATH/.krew/"
PATH_add "$DIRENV_PATH/.krew/bin"

#
# terraform
#
export TF_TOKEN_app_terraform_io="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yaml | yq -r .credentials.terraform.cloud.testing_farm_bot.token)"
export TF_VAR_cluster_name="${TF_VAR_cluster_name:-testing-farm-dev-$USER}"
export TF_VAR_ansible_vault_password_file="$PROJECT_ROOT/.vault_pass"
export TF_VAR_ansible_vault_credentials="credentials.yaml"
export TF_VAR_ansible_vault_secrets_root="$PROJECT_ROOT/secrets"

#
# Testing Farm tokens
#
export TESTING_FARM_API_TOKEN_PUBLIC="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yaml | yq -r .credentials.testing_farm.ranch.public.bot_api_key)"
export TESTING_FARM_API_TOKEN_REDHAT="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yaml | yq -r .credentials.testing_farm.ranch.redhat.bot_api_key)"

#
# gitlab-ci-linter
#
export GITLAB_PRIVATE_TOKEN="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yaml | yq -r .credentials.gitlab.testing_farm_bot.token)"
