#
# Poetry layout
#
layout_poetry() {
  if [[ ! -f pyproject.toml ]]; then
    log_error 'No pyproject.toml found. Use `poetry new` or `poetry init` to create one first.'
    exit 2
  fi

  # create venv if it doesn't exist
  poetry run true

  export VIRTUAL_ENV=$(poetry env info --path)
  export POETRY_ACTIVE=1
  PATH_add "$VIRTUAL_ENV/bin"
}

#
# vars
#
export PROJECT_ROOT=$(pwd)
export DIRENV_PATH="$PROJECT_ROOT/.direnv"
export TOOLS_PATH="$DIRENV_PATH/bin"

#
# poetry
#
layout_poetry

#
# required
#
if [ ! -e "$PROJECT_ROOT/.vault_pass" ]; then
    echo -e "\e[31mâ›” Please create '.vault_pass' in project root '$PROJECT_ROOT'"
    exit 1
fi

#
# setup
#
if [ ! -e "$DIRENV_PATH" ]; then
  source setup/environment.sh
else
  echo -e "\e[32mðŸ’¡ Use 'make clean; direnv allow' to reinstall\e[0m"
fi

#
# tools
#
PATH_add "$TOOLS_PATH"

#
# aws
#
export AWS_CONFIG_FILE="$DIRENV_PATH/.aws/config"
export AWS_SHARED_CREDENTIALS_FILE="$DIRENV_PATH/.aws/credentials"

#
# kubectl
#
export KUBECONFIG="$DIRENV_PATH/.kube/config"
