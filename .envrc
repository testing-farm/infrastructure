#
# Direnv setup script
#

layout_poetry() {
  if [[ ! -f pyproject.toml ]]; then
    log_error 'No pyproject.toml found. Use `poetry new` or `poetry init` to create one first.'
    exit 2
  fi

  # create venv if it doesn't exist
  poetry run true

  export VIRTUAL_ENV=$(poetry env info --path)
  export POETRY_ACTIVE=1
  PATH_add "$VIRTUAL_ENV/bin"
}

#
# vars
#
PROJECT_ROOT=$(pwd)

#
# helpers
#
info() { echo -e "\e[32m[+] $@\e[0m"; }
print_error() { echo -e "\e[31m[E] $@\e[0m"; }
error() { print_error $@; exit 1; }
warn() { echo -e "\e[33m[+] $@\e[0m"; }

#
# .vault_pass is required to be created
#

info "Checking for vault password"
[ -e "$PROJECT_ROOT/.vault_pass" ] || error "Please create '.vault_pass' in project root '$PROJECT_ROOT'"

#
# Setup poetry layout
#
layout_poetry

#
# install all requirements via poetry
#
poetry install

#
# make sure bin tools dir exists
#
mkdir -p tools/bin

#
# download kubectl
#
if [ ! -e "$PROJECT_ROOT/tools/bin/kubectl" ]; then
    info "downloading kubectl 1.15"
    curl -Lo $PROJECT_ROOT/tools/bin/kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.15.10/2020-02-22/bin/linux/amd64/kubectl
    chmod +x $PROJECT_ROOT/tools/bin/kubectl
fi

#
# download helm
#
if [ ! -e "$PROJECT_ROOT/tools/bin/helm" ]; then
    info "downloading helm 3.2.1"
    TEMPDIR=$(mktemp -d)
    curl -Lo $TEMPDIR/helm.tar.gz https://get.helm.sh/helm-v3.2.1-linux-amd64.tar.gz
    tar -xvC $TEMPDIR -f $TEMPDIR/helm.tar.gz
    mv $TEMPDIR/linux-amd64/helm $PROJECT_ROOT/tools/bin/helm
    rm -rf $TEMPDIR
fi

#
# setup kubectl
#
if [ "$(command -v kubectl 2>/dev/null)" != "$PROJECT_ROOT/tools/kubectl" ]; then

    info "kubectl, krew and some nice plugins"

    # download and install krew
    if [ ! -e "$PROJECT_ROOT/tools/bin/krew" ]; then
        export KREW_ROOT=$PROJECT_ROOT/tools/.krew/
        export PATH=$PROJECT_ROOT/tools/.krew/bin:$PATH
        export PATH=$PROJECT_ROOT/tools/bin:$PATH

        info "downloading and installing krew"
        TEMPDIR=$(mktemp -d)
        curl -Lo $TEMPDIR/krew.tar.gz "https://github.com/kubernetes-sigs/krew/releases/latest/download/krew.tar.gz"
        curl -Lo $TEMPDIR/krew.yaml "https://github.com/kubernetes-sigs/krew/releases/latest/download/krew.yaml"
        tar -xvC $TEMPDIR -f $TEMPDIR/krew.tar.gz
        mv $TEMPDIR/krew-linux_amd64 $PROJECT_ROOT/tools/bin/krew
        chmod +x $PROJECT_ROOT/tools/bin/krew
        krew install --manifest=$TEMPDIR/krew.yaml --archive=$TEMPDIR/krew.tar.gz
        info "installing kubectl plugins ctx, ns"
        kubectl krew install ctx
        kubectl krew install ns
        rm -rf $TEMPDIR
    fi

    export AWS_ACCESS_KEY_ID="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yml | yq -r .credentials.aws.fedora.access_key)"
    export AWS_SECRET_ACCESS_KEY="$(ansible-vault view --vault-password-file .vault_pass secrets/credentials.yml | yq -r .credentials.aws.fedora.secret_key)"
    export AWS_DEFAULT_REGION="us-east-1"

    info "AWS credentials"

    mkdir -p $PROJECT_ROOT/tools/.kube
    export KUBECONFIG="$PROJECT_ROOT/tools/.kube/config"
    touch $KUBECONFIG

    info "EKS cluster 'testing-farm'"
    aws eks update-kubeconfig --name testing-farm
fi
