#
# Various workarounds for Automotive
#
# * fix yum repositories, seems $stream is not expanded correctly
# * install rsync, because tmt requires it ...
# * install latest tmt until 1.10 is not released - TFT-961
#

- block:
    - name: Fix unexpanded $stream in yum repositories
      shell: "sed -i 's/$stream/9-stream/' /etc/yum.repos.d/*"

    - name: Install rsync via rpm-ostree
      command: "rpm-ostree install rsync"

    - name: Restart
      reboot:

    - name: Wait for connection for 5 minutes
      wait_for_connection:
        delay: 5
        timeout: 300

    - name: Name lock file to mitigate race condition in updating worker
      set_fact:
        lock_file_path: /var/tmp/workaround-automotive.lock

    - name: Create lock file
      stat: path={{ lock_file_path }}
      register: lock_file
      retries: 3
      delay: 5
      until: lock_file.rc == 0

    - block:
        - name: Enable tmt copr repository
          command: "dnf -y copr enable psss/tmt"

        - name: Install latest tmt
          command: "dnf -y update tmt-provision-container tmt-provision-virtual"
      when: not lock_file.stat.exists|bool
      delegate_to: localhost

  when: '"auto-osbuild" in IMAGE_NAME|lower'
