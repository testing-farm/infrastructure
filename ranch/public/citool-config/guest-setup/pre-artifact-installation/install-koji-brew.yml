---
- name:
  block:
    - name: Install dnf-utils, need for the next workaround task
      package:
        name:
          - dnf-utils
        state: present

    - name: Enable copr with koji workarounding pagure.io/koji/issue/3461
      command: "dnf -y copr enable @osci/koji"

    - name: Install Koji
      package:
        name:
          - koji-1.28.1
        state: present
      when:
      retries: "{{ pkg_retry_count }}"
      delay: "{{ pkg_retry_delay }}"
      until: result_package is succeeded
      register: result_package
  when:
    - 'ansible_distribution == "Fedora" or
       ansible_distribution == "CentOS" or
       ansible_distribution == "OracleLinux"'
    # we do not want to install Koji on Automotive images
    - '"auto-osbuild" not in IMAGE_NAME|lower'

- block:
    - name: Add RCM Repository for RHEL7 and earlier
      yum_repository:
        description: RCMTOOLS repository
        name: rcmtools
        state: present
        gpgcheck: no
        baseurl: "http://download.devel.redhat.com/rel-eng/RCMTOOLS/latest-RCMTOOLS-2-RHEL-{{ ansible_distribution_major_version }}/compose/Server/{{ ansible_architecture }}/os/"

    - name: Install Brewkoji
      package:
        name: brewkoji
      retries: "{{ pkg_retry_count }}"
      delay: "{{ pkg_retry_delay }}"
      until: result_package is succeeded
      register: result_package

  when:
    - 'ansible_distribution == "RedHat"'
    - 'ansible_distribution_major_version <= "7"'

- block:
    - name: Add RCM Repository for RHEL 8
      yum_repository:
        description: RCMTOOLS repository
        name: rcmtools
        state: present
        gpgcheck: no
        baseurl: "http://download.devel.redhat.com/rel-eng/RCMTOOLS/latest-RCMTOOLS-2-RHEL-{{ ansible_distribution_major_version }}/compose/BaseOS/{{ ansible_architecture }}/os/"

    - name: Install Brewkoji
      package:
        name: brewkoji
      retries: "{{ pkg_retry_count }}"
      delay: "{{ pkg_retry_delay }}"
      until: result_package is succeeded
      register: result_package

  when:
    - 'ansible_distribution == "RedHat"'
    - 'ansible_distribution_major_version == "8"'
