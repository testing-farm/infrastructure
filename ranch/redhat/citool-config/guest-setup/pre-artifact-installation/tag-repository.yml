---

#
# Add tag repository with low priority, for installing additional dependencies of tested artifacts.
#
# The tag repository is updated by Brew/Koji. It contains all packages that got into a specific tag.
# The repository is sometimes also referred to as buildroot or brewroot repository inside Red Hat.
#
# Examples for RHEL:
# * rhel-8.1.0-build contains all builds tagged into rhel-8.1.0-candidate
# * rhel-7.7-build contains all builds tagged into rhel-7.7-candidate
# * rhel-9.0.0-beta-build contains all builds tagged into rhel-9.0.0-beta-candidate
#
# Note that *-build tags inherit from *-candidate tags
#
# The play gracefully skips adding a tag repository which is not reachable.
#

- block:

    #
    # The tag repository name can be transformed from IMAGE_NAME variable.
    #
    - name: Transform build target to a tag repository name (RHEL)
      set_fact:
        tag_repository_name: "{{ IMAGE_NAME | regex_replace('(?i)^.*rhel-(\\d+\\.\\d+(?:\\.\\d+)?(?:-alpha|-beta)?).*$', 'rhel-\\1-build') | lower }}"

    - name: Create tag repository base url (RHEL)
      set_fact:
        tag_repository_url: "http://download.devel.redhat.com/brewroot/repos/{{ tag_repository_name }}/latest/{{ ansible_architecture }}/"

    #
    # Set the priority to lowest, this will make sure latest updates are not pulled in instead of default repository
    #
    - name: Set tag repository priority
      set_fact:
        tag_repository_priority: 999

    #
    # Check if tag repository exists.
    #
    # Note: We ignore the fact the repository does not exist and try to continue anyway. Note that not all builds
    #       we encounter might have tag repository available.
    #
    - name: "Check if tag repository {{ tag_repository_url }} exists"
      uri:
        url: "{{ tag_repository_url }}"
        method: HEAD
        status_code: [200, 404]
      register: http_response

    #
    # Add repository only if the repository is reachable
    #
    # For < RHEL8 we need to install yum-plugin-priorities
    #
    - block:
        - name: Make sure yum-plugin-priorities is installed on < RHEL8
          package:
            name: yum-plugin-priorities
            state: present
          when:
            - ansible_distribution == "RedHat"
            - ansible_distribution_major_version|int < 8

        - name: Add tag repository
          template:
            src: "../templates/tag.repo.j2"
            dest: /etc/yum.repos.d/tag-repository.repo

      when: http_response.status == 200

    #
    # block: end
    #

    #
    # Be verbose about the fact the repository is unreachable
    #
    - debug:
        msg: "Skipping adding tag repository, because location {{ tag_repository_url }} was not found"
      when: http_response.status != 200

  #
  # Run block if BUILD_TARGET and PRIMARY_TASK variables are available.
  # Also, we do not support tag repository for all known task namespaces.
  #

  when:
    - IMAGE_NAME is defined
    - ansible_distribution == "RedHat"

  #
  # block: end
  #

#
# Be verbose about the fact we skipped this play
#
- debug:
    msg: |
      Skipping adding tag repository, because IMAGE_NAME variable is undefined,
      or it is unsupported.

  when: IMAGE_NAME is undefined
