---
#
# This workaround is here for the case when beaker-client repository
# is unavailable. Some images require this repository to be available,
# make sure we make it optional everywhere.
#
# Added during October 2021 outage, see TFT-765 for more information.
#
- name: Set required variables
  set_fact:
    beaker_client_repo_file: "/etc/yum.repos.d/beaker-client.repo"

- name: Check if beaker_client repo file exists
  stat:
    path: "{{ beaker_client_repo_file }}"
  register: beaker_client_repo_file_status

- block:
    - name: Set beaker-client repository as optional (skip_if_unavailable=1)
      ini_file:
        path: "{{ beaker_client_repo_file }}"
        section: beaker-client
        option: skip_if_unavailable
        value: "1"

  #
  # Run block only if file exists
  #
  when:
    - beaker_client_repo_file_status.stat.exists
    - '"auto-osbuild" not in IMAGE_NAME|lower'

#
# Be verbose about the fact we skipped the workaround
#
- debug:
    msg: "Skipping workaround, because beaker_client_repo_file does not exist"
  when:
    - not beaker_client_repo_file_status.stat.exists
    - '"auto-osbuild" in IMAGE_NAME|lower'
