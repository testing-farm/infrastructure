---
default:
  image: quay.io/testing-farm/python-ci-image

.direnv:
  before_script:
    - echo -n "$VAULT_PASSWORD" > .vault_pass
    - export ANSIBLE_VAULT_PASSWORD_FILE=.vault_pass
    - dnf -y install direnv
    - direnv allow
    - eval "$(direnv export bash)"

stages:
  - ğŸ”

ansible-vault:
  extends: .direnv
  stage: ğŸ”
  script:
    - dnf -y install ansible-lint
    - ansible-vault decrypt secrets/credentials.yml
    - ansible-lint secrets/credentials.yml
  rules:
    - changes:
        - secrets/credentials.yml

pre-commit:
  extends: .direnv
  stage: ğŸ”
  script:
    - dnf -y install pre-commit
    - pre-commit run --all-files
  rules:
    - when: always

terraform:
  extends: .direnv
  stage: ğŸ”
  script:
    - cd terraform/environments/dev
    - export TF_VAR_cluster_name=testing-farm-gitlab-ci-$CI_COMMIT_REF_NAME
    - terraform init
    - terraform plan
    - terraform apply -auto-approve
    - aws eks --region us-east-2 update-kubeconfig --name $TF_VAR_cluster_name
  after_script:
    - eval "$(direnv export bash)"
    - cd terraform/environments/dev
    - terraform destroy -auto-approve
  rules:
    - changes:
        - secrets/credentials.yml
        - terraform/environments/dev
        - terraform/modules
        - .envrc
