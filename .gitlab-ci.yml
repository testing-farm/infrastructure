---
default:
  image: "quay.io/testing-farm/python-ci-image:2023-05-23-73a71064"

variables:
  # GitLab CI runs in world writable directory, we need to explicitely
  # set ANSIBLE_CONFIG.
  #
  # https://docs.ansible.com/ansible/devel/reference_appendices/config.html#cfg-in-world-writable-dir
  ANSIBLE_CONFIG: ansible.cfg

.direnv:
  before_script:
    - echo -n "$VAULT_PASSWORD" > .vault_pass
    - dnf -y install direnv
    - direnv allow
    - eval "$(direnv export bash)"

stages:
  - ğŸ”

ansible-vault:
  extends: .direnv
  stage: ğŸ”
  script:
    - >
      ansible-vault view ansible/secrets/credentials.yml | yamllint -d "rules: {line-length: {level: warning}}" -
  rules:
    - changes:
        - ansible/secrets/credentials.yml

pre-commit:
  extends: .direnv
  stage: ğŸ”
  script:
    - dnf -y install pre-commit
    - pre-commit run --all-files
  rules:
    - when: always
