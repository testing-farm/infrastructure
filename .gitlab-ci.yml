---
default:
  image: quay.io/testing-farm/python-ci-image:2022-09-22-f36b4b1c

variables:
  # GitLab CI runs in world writable directory, we need to explicitely set ANSIBLE_CONFIG
  # https://docs.ansible.com/ansible/devel/reference_appendices/config.html#cfg-in-world-writable-dir
  ANSIBLE_CONFIG: ansible.cfg

workflow:
  rules:
    # for merge requests
    - if: $CI_MERGE_REQUEST_ID
    # for the tip of the default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

.direnv:
  before_script:
    - echo -n "$VAULT_PASSWORD" > .vault_pass
    - dnf -y install direnv libffi libffi-devel
    - direnv allow
    - eval "$(direnv export bash)"

stages:
  - üîç

ansible-vault:
  extends: .direnv
  stage: üîç
  script:
    - dnf -y install ansible-lint
    - >
      ansible-vault view secrets/credentials.yaml | yamllint -d "rules: {line-length: {level: warning}}" -
  rules:
    - changes:
      - secrets/credentials.yaml

pre-commit:
  extends: .direnv
  stage: üîç
  script:
    - dnf -y install pre-commit
    - PRE_COMMIT_HOME=$CI_PROJECT_DIR/.cache/pre-commit pre-commit run --all-files
  cache:
    paths:
      - $CI_PROJECT_DIR/.cache
  rules:
    - when: always

terraform:
  extends: .direnv
  stage: üîç
  script:
    # TODO: tmt run -e cluster_name=testing-farm-gitlab-ci-$CI_COMMIT_REF_NAME plan --name /terraform/environments/dev
    - export TF_VAR_cluster_name=testing-farm-gitlab-ci-${CI_COMMIT_REF_NAME:0:10}-$CI_JOB_ID
    - cd terraform/environments/dev
    - terraform init
    - terraform plan -out tfplan
    - terraform apply tfplan
    - context=$(aws eks --region us-east-2 update-kubeconfig --name $TF_VAR_cluster_name | grep -o "arn[^ ]*")
    - kubectl ctx $context
    - kubectl ns default
    - kubectl run fedora --image fedora:35 -- sleep infinity
    - kubectl wait --for=condition=Ready pod/fedora
    - kubectl exec pod/fedora -- cat /etc/os-release | grep '^ID=fedora$'
    - kubectl delete pod/fedora
    # Destroy all created resources. Note that for success case this can take long
    # and after_script has timeout hardcoded to 5 mins, keeping leftovers.
    - terraform destroy -auto-approve
  after_script:
    - eval "$(direnv export bash)"
    - export TF_VAR_cluster_name=testing-farm-gitlab-ci-${CI_COMMIT_REF_NAME:0:10}-$CI_JOB_ID
    - cd terraform/environments/dev
    - terraform destroy -auto-approve
  rules:
    - changes:
        - secrets/credentials.yaml
        - terraform/environments/common/**/*
        - terraform/environments/dev/**/*
        - terraform/modules/**/*
        - terraform/*.tf
        - terraform/*.tftpl
        - .envrc

deploy/staging:
  extends: .direnv
  stage: üîç
  script:
    - cd terraform/environments/staging
    - terraform init
    - terraform plan -out tfplan
    - terraform apply tfplan
  rules:
    # Only default branch
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never
    - changes:
        - secrets/credentials.yaml
        - terraform/environments/common/**/*
        - terraform/environments/staging/**/*
        - terraform/modules/**/*
        - terraform/*.tf
        - terraform/*.tftpl
        - .envrc
